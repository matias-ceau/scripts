# Sync Git Repository Utility

---

**sync-repo.sh**: Synchronize a local git repository with its remote, handling stashes, conflicts, and pretty output

---

### Dependencies

- `git`: Essential version control tool.
- `bat`: Optional, for syntax-highlighted command and output display.
- `glow`: Optional, for rich markdown rendering in the terminal.
- External editor: Uses `${EDITOR}` variable or defaults to `vim`/`nvim` for conflict resolutions.

---

### Description

This script automates the process of syncing a local git repository with its upstream remote. It enhances standard git operations with user-friendly output, colorized messages, conflict resolution prompts, and a dry-run feature. 

Key features include:

- **Pretty Output:** If `bat` or `glow` are installed, the script visually enhances command output for easier comprehension.
- **Error Handling:** Functions for clear error reporting and early exit.
- **Conflict Management:** If merge or rebase conflicts occur, or if stashed changes cannot be applied cleanly, you are prompted with interactive options to resolve them:
    - Open $EDITOR for manual resolution,
    - Abort, or
    - Accept either the local or remote version for stash conflicts.
- **Automation Steps:**
    - Fetch remote updates.
    - Stash local (uncommitted) changes if required.
    - Try fast-forward merge, fall back to rebase.
    - Re-apply stashed changes and resolve conflicts if needed.
    - Add, commit with autogenerated message, and push changes.
    - Run `git maintenance run`.
    - Display a concise post-sync summary, leveraging `glow` if available.

#### Main Functions

- `print_command`, `run_command`: Display and execute commands, optionally piping through `bat`.
- `handle_merge_pull_conflicts`, `handle_stash_conflict`: Interactive, user-driven resolution for common git problems.
- `display_summary`: Summarizes changes after sync.
- Usage/help output via `print_usage`.

---

### Usage

In terminal:

```
./sync-repo.sh <repository_path> [--dry-run] [--help]
```

**Examples:**

```
./sync-repo.sh ~/.scripts
sync-repo.sh $SCRIPTS --dry-run
git_sync $SCRIPTS
```

You can assign this script to a qtile keybinding or run manually for interactive sync sessions.  
The `--dry-run` flag will show the intended actions without making changes. Use `--help` to display usage information.

---

> [!TIP]
>
> - The script is robust and interactive, but depends on external editors and assumes user comfort with manual merge resolution in editors like `vim` or `nvim`.
> - There is some redundancy in color definitions (`MAGENTA` is set to the code for cyan); you may want to assign colors more carefully for clarity.
> - Conflict handling is manual; could be enhanced by suggesting commands or providing more context on file differences before editing.
> - Autogenerated commit messages are basic; you might want to integrate a smarter commit message generator or LLM hook if consistent, high-quality messages are important.
> - Consider adding more checks: whether the remote branch exists, or prompting to set upstream if `@{u}` is undefined.
> - The repo name deduction using `sed` might fail on remotes with unconventional URLs; a more robust parse could help.